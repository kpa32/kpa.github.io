<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 iptables 的 tproxy 完成本机访问家里内网的透明代理 | kpa</title>
    <meta name="description" content="第二记忆.">
    <meta name="generator" content="VitePress v1.1.4">
    <link rel="preload stylesheet" href="/assets/style.ANtz78Il.css" as="style">
    <script type="module" src="/assets/chunks/metadata.44e6dab7.js"></script>
    <script type="module" src="/assets/app.IxE01jpQ.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.DnJfIKBR.js">
    <link rel="modulepreload" href="/assets/chunks/theme.CHtsh84d.js">
    <link rel="modulepreload" href="/assets/post_未分类_使用-iptables-的-tproxy-完成本机访问家里内网的透明代理.md.D9hwtWec.lean.js">
    <link rel="icon" href="/favicon.jpg">
    <script id="register-sw">"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js");</script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=TAG_ID"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","TAG_ID");</script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-ad552957><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-ad552957 data-v-ae24b3ad><div class="VPNavBar has-sidebar top" data-v-ae24b3ad data-v-ccf7ddec><div class="wrapper" data-v-ccf7ddec><div class="container" data-v-ccf7ddec><div class="title" data-v-ccf7ddec><div class="VPNavBarTitle has-sidebar" data-v-ccf7ddec data-v-ab179fa1><a class="title" href="/" data-v-ab179fa1><!--[--><!--]--><!--[--><img class="VPImage logo" src="/favicon.jpg" alt data-v-8426fc1a><!--]--><span data-v-ab179fa1>kpa</span><!--[--><!--]--></a></div></div><div class="content" data-v-ccf7ddec><div class="content-body" data-v-ccf7ddec><!--[--><!--]--><div class="blog-search search" data-pagefind-ignore="all" data-v-ccf7ddec style="--1af60572:1;" data-v-a3e043fe><div class="nav-search-btn-wait" data-v-a3e043fe><span data-v-a3e043fe><svg width="14" height="14" viewBox="0 0 20 20" data-v-a3e043fe><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round" data-v-a3e043fe></path></svg></span><span style="" class="search-tip" data-v-a3e043fe>搜索</span><span style="" class="metaKey" data-v-a3e043fe> K </span></div><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-ccf7ddec data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-7f418b0f data-v-9c663999><!--[--><span data-v-9c663999>主页</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/page/index" tabindex="0" data-v-7f418b0f data-v-9c663999><!--[--><span data-v-9c663999>导航</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-7f418b0f data-v-b6c34ac9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-b6c34ac9><span class="text" data-v-b6c34ac9><!----><span data-v-b6c34ac9>知识入脑</span><span class="vpi-chevron-down text-icon" data-v-b6c34ac9></span></span></button><div class="menu" data-v-b6c34ac9><div class="VPMenu" data-v-b6c34ac9 data-v-e7ea1737><div class="items" data-v-e7ea1737><!--[--><!--[--><div class="VPMenuGroup" data-v-e7ea1737 data-v-69e747b5><!----><!--[--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-43f1e123><a class="VPLink link" href="/post/Android/AOSP%E4%BB%A3%E7%A0%81%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE" data-v-43f1e123><!--[-->AOSP编译环境<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-43f1e123><a class="VPLink link" href="/post/Android/AOSP%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0" data-v-43f1e123><!--[-->AOSP开发指南<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-e7ea1737 data-v-69e747b5><!----><!--[--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-43f1e123><a class="VPLink link" href="/post/Android/Lsposed%E7%BC%96%E8%AF%91%E6%8C%87%E5%8D%97" data-v-43f1e123><!--[-->Lsposed编译<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-43f1e123><a class="VPLink link" href="/post/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/WSL2-Ubuntu24.04" data-v-43f1e123><!--[-->Wsl2安装<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/post/index" tabindex="0" data-v-7f418b0f data-v-9c663999><!--[--><span data-v-9c663999>笔记</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-ccf7ddec data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="切换到深色模式" aria-checked="false" data-v-e6aabb21 data-v-d1f28634 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-d1f28634></span><span class="vpi-moon moon" data-v-d1f28634></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-ccf7ddec data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github1s.com/kpa32/github_blog" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-ccf7ddec data-v-d0bd9dde data-v-b6c34ac9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-b6c34ac9><span class="vpi-more-horizontal icon" data-v-b6c34ac9></span></button><div class="menu" data-v-b6c34ac9><div class="VPMenu" data-v-b6c34ac9 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-d0bd9dde><div class="item appearance" data-v-d0bd9dde><p class="label" data-v-d0bd9dde>Appearance</p><div class="appearance-action" data-v-d0bd9dde><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="切换到深色模式" aria-checked="false" data-v-d0bd9dde data-v-d1f28634 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-d1f28634></span><span class="vpi-moon moon" data-v-d1f28634></span><!--]--></span></span></button></div></div></div><div class="group" data-v-d0bd9dde><div class="item social-links" data-v-d0bd9dde><div class="VPSocialLinks social-links-list" data-v-d0bd9dde data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github1s.com/kpa32/github_blog" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-ccf7ddec data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-ccf7ddec><div class="divider-line" data-v-ccf7ddec></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-ad552957 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a6f0e41e><span class="vpi-align-left menu-icon" data-v-a6f0e41e></span><span class="menu-text" data-v-a6f0e41e>目录</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-17a5e62e><button data-v-17a5e62e>返回顶部</button><!----></div></div></div><aside class="VPSidebar" data-v-ad552957 data-v-575e6a36><div class="curtain" data-v-575e6a36></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-575e6a36><span class="visually-hidden" id="sidebar-aria-label" data-v-575e6a36> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-575e6a36><section class="VPSidebarItem level-0 has-active" data-v-575e6a36 data-v-b8d55f3b><!----><div class="items" data-v-b8d55f3b><!--[--><section class="VPSidebarItem level-1 collapsible" data-v-b8d55f3b data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h3 class="text" data-v-b8d55f3b>AOSP</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b8d55f3b><span class="vpi-chevron-right caret-icon" data-v-b8d55f3b></span></div></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/AOSP-ART-Hook.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>AOSP-ART-Hook</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/AOSP-Pixel3-内核编译支持 eBPF.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>AOSP-Pixel3-内核编译支持 eBPF</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/AOSP-Pixel6-内核编译.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>AOSP-Pixel6-内核编译</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/AOSP-Pixel6-内核编译2.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>AOSP-Pixel6-内核编译2</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/AOSP-模拟器.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>AOSP-模拟器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/AOSP-隐藏调试.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>AOSP-隐藏调试</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/AOSP代码环境配置.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>AOSP代码环境配置</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/AOSP开发笔记.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>AOSP开发笔记</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/Cuttlefish学习.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Cuttlefish学习</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/Redroid安装模拟器.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Redroid安装模拟器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/Redroid编译.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Redroid编译</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/Xiaomi5刷机编译.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Xiaomi5刷机编译</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/AOSP/整理第三方ROM列表.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>整理第三方ROM列表</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible" data-v-b8d55f3b data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h3 class="text" data-v-b8d55f3b>Android</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b8d55f3b><span class="vpi-chevron-right caret-icon" data-v-b8d55f3b></span></div></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/Android/Lsposed编译指南.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Lsposed编译指南</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/Android/TotalComputer.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>TotalComputer</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/Android/Xposed模块编写.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Xposed模块编写</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/Android/android-coresight学习.ts.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>android-coresight学习ts</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/Android/android-eadb安装 .html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>android-eadb安装 </p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/Android/app_process启动自定义app-jar.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>app_process启动自定义app-jar</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/Android/simpleperf命令整理.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>simpleperf命令整理</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible" data-v-b8d55f3b data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h3 class="text" data-v-b8d55f3b>Vitepress</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b8d55f3b><span class="vpi-chevron-right caret-icon" data-v-b8d55f3b></span></div></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/Vitepress/Vitepress指南.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Vitepress指南</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible" data-v-b8d55f3b data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h3 class="text" data-v-b8d55f3b>代码片段</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b8d55f3b><span class="vpi-chevron-right caret-icon" data-v-b8d55f3b></span></div></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/代码片段/Adb.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Adb</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/代码片段/Bat&amp;Sh.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Bat&Sh</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/代码片段/Git.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Git</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/代码片段/Linux.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Linux</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/代码片段/Socks5&amp;Http Proxy测试节点.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Socks5&Http Proxy测试节点</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/代码片段/反汇编.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>反汇编</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible" data-v-b8d55f3b data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h3 class="text" data-v-b8d55f3b>反汇编</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b8d55f3b><span class="vpi-chevron-right caret-icon" data-v-b8d55f3b></span></div></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/反汇编/Frida计算got-plt计算hook点.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Frida计算got-plt计算hook点</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/反汇编/反汇编笔记.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>反汇编笔记</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible" data-v-b8d55f3b data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h3 class="text" data-v-b8d55f3b>开发环境</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b8d55f3b><span class="vpi-chevron-right caret-icon" data-v-b8d55f3b></span></div></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/开发环境/Docker说明.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Docker说明</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/开发环境/Frida-Vscode调试脚本.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Frida-Vscode调试脚本</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/开发环境/WSL2-Ubuntu24.04.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>WSL2-Ubuntu2404</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible" data-v-b8d55f3b data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h3 class="text" data-v-b8d55f3b>开源项目-demo</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b8d55f3b><span class="vpi-chevron-right caret-icon" data-v-b8d55f3b></span></div></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/开源项目-demo/Java-AOP框架-lancet.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>Java-AOP框架-lancet</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible has-active" data-v-b8d55f3b data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h3 class="text" data-v-b8d55f3b>未分类</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b8d55f3b><span class="vpi-chevron-right caret-icon" data-v-b8d55f3b></span></div></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/未分类/https-ssl证书生成与使用.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>https-ssl证书生成与使用</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/未分类/iptabls模拟器.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>iptabls模拟器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/未分类/win10远程共享文件夹.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>win10远程共享文件夹</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/未分类/使用-iptables-的-tproxy-完成本机访问家里内网的透明代理.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>使用-iptables-的-tproxy-完成本机访问家里内网的透明代理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/未分类/博客设置相关.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>博客设置相关</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible" data-v-b8d55f3b data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h3 class="text" data-v-b8d55f3b>汇编</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b8d55f3b><span class="vpi-chevron-right caret-icon" data-v-b8d55f3b></span></div></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/汇编/arm64学习.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>arm64学习</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible" data-v-b8d55f3b data-v-b8d55f3b><div class="item" role="button" tabindex="0" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><h3 class="text" data-v-b8d55f3b>生活</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b8d55f3b><span class="vpi-chevron-right caret-icon" data-v-b8d55f3b></span></div></div><div class="items" data-v-b8d55f3b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-b8d55f3b data-v-b8d55f3b><div class="item" data-v-b8d55f3b><div class="indicator" data-v-b8d55f3b></div><a class="VPLink link link" href="/post/生活/办公显示器的选择.html" data-v-b8d55f3b><!--[--><p class="text" data-v-b8d55f3b>办公显示器的选择</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-pagefind-body data-v-ad552957 data-v-1428d186><div class="VPDoc has-sidebar has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-269c27a6><div class="content" data-v-269c27a6><div class="outline-marker" data-v-269c27a6></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-269c27a6>目录</div><ul class="VPDocOutlineItem root" data-v-269c27a6 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _post_%E6%9C%AA%E5%88%86%E7%B1%BB_%E4%BD%BF%E7%94%A8-iptables-%E7%9A%84-tproxy-%E5%AE%8C%E6%88%90%E6%9C%AC%E6%9C%BA%E8%AE%BF%E9%97%AE%E5%AE%B6%E9%87%8C%E5%86%85%E7%BD%91%E7%9A%84%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86" data-v-39a288b8><div><p>最近正在尝试将主力笔记本从 Mac 换到 Linux，首先要解决的就是网络问题 ~（桌面美化）~。本文介绍了笔者在使用 Linux 内核支持的 tproxy（Transparent proxy）让本机（手里的笔记本）访问外网流量时通过 tproxy 完成，同时本机在家里内网环境时访问内网流量不经过 tproxy，在其他环境下，访问的家里内网流量经过 tproxy。</p><blockquote><ol><li>由于笔者没有看过完整的计算机网络，甚至连 TCP 握手是什么都不知道，导致很多内容的可能不准确/有错误。</li><li>光看个 tproxy 配置不理解其中的含义，很可能导致配置出来的有问题，所以本文会尽可能写出我对每一行命令（配置）的理解，这样才能在遇到各种网络环境/需求下，都能得心应手。</li></ol></blockquote><h2 id="nat-network-address-translation-是什么" tabindex="-1"><a href="#nat-network-address-translation-是什么">#</a> NAT（Network address translation）是什么？ <a class="header-anchor" href="#nat-network-address-translation-是什么" aria-label="Permalink to &quot;[#](#nat-network-address-translation-是什么) NAT（Network address translation）是什么？&quot;">​</a></h2><p>在介绍 tproxy 之前，我们需要先大致知道 NAT 是什么。可能因为 IP 地址的短缺，无法为每台设备都提供的一个全球独立的 IP，NAT 应运而生。</p><p>我们来画个图，看一下 NAT 是如何帮助一台内网的设备和外网的服务进行通信的。</p><p><img src="https://blog.indigo.codes/assets/img/iptables-tproxy-and-home-1.be8351a6.png" alt=""></p><p>假定我们的内网 IP 段为 192.168.22.0/24（192.168.2.0-192.168.22.255），内网网关（路由器）拥有两个接口，一个对应内网的 192.168.22.1，一个是公网 119.3.70.188，我们要访问的服务拥有的 IP 为 120.92.78.97。</p><p>我们的设备（192.168.22.33）会向网关发一个 IP 数据包，这里包含了两个关键信息，目的地 IP（120.92.78.97）和来源 IP（192.168.22.33），这样一来网关知道这个数据该给谁，数据回来的时候又该送回哪里。</p><p>网关进行一次 SNAT 转换，将来源 IP 换成自身的公网 IP，这样发给服务器的数据服务器才能知道响应给谁。服务器收到数据后，会返回一个数据包，这里仍然会标记上来源 IP 为服务器的 IP。响应到网关的数据包，网关进行一个 DNAT 转换，将目标地址 IP 换成我们的设备 IP，并将数据包发给设备。</p><p>从以上的过程中，我们可以得到两个重要结论：</p><ul><li>一次网络数据交换是<strong>有来有回</strong>的</li><li>从本机发出去和接收的数据中，<strong>来源 IP 和目标 IP 都是外网 IP 和本机 IP</strong></li></ul><p>我们带着这两个结论来看数据包是如何从本机出去的，回来的数据包又在本机上经过了什么？</p><h2 id="output-和-prerouting-chain" tabindex="-1"><a href="#output-和-prerouting-chain">#</a> OUTPUT 和 PREROUTING chain <a class="header-anchor" href="#output-和-prerouting-chain" aria-label="Permalink to &quot;[#](#output-和-prerouting-chain) OUTPUT 和 PREROUTING chain&quot;">​</a></h2><blockquote><p>这里不会详细介绍 iptables 的 table 和 chain，文末链接中有大量相关的内容介绍。</p></blockquote><p>从本机出去的数据包会经过 OUTPUT 链，而从外部发往本机的数据包会经过 PREROUTING 链（当然也会经过 INPUT 链，但因为 tproxy 只能工作在 PREROUTING 链，所以我们只关心 PREOUTING 链），这对应了上面的<strong>有来有回，为了区分各种场景的数据包，我们会用到来源 IP 和目标 IP</strong>，比如在 OUTPUT 链中，目标 IP 为外网时，应当经过 tproxy。 由于 tproxy 只能工作在 PREROUTING 链，从本机发出去的数据包会直接通过 OUTPUT 链出去了，本机数据包没有机会走一下 PREROUTING 链。</p><p>为了让本机数据经过 PREROUTING，我们可以用的路由表解决（这部分我没有完全理解指令每个参数的含义，但大致够用了）。</p><p>执行如下命令：</p><p>第一行添加一条 ip 规则，表示被标记为 23 的的数据包的走向要查表 2233。 第二行大致是说对于 2233 表的流量，都要发到本机（经过本机的 PREROUTING）。</p><p>当我们给 OUTPUT 链的数据包进行标记时，这个数据包会重新查一次表，如果我们标记的刚好是 23，那这个数据包就会根据上面的规则进入本机的 PREROUTING。这样一来，我们就可以将本机的数据包发送的 tproxy。</p><p>在 OUTPUT 链上打标记命令如下：</p><p>解释一下上面的两条命令，iptables 中有三个常用的表，filter、nat 和 mangle，三个表有各自的用途，能链的作用范围也不一样，mangle 表支持在 OUTPUT 链上打标记。</p><p>这里有一堆缩写参数，导致理解起来比较困难，如下是相关解释：</p><ul><li><code>-t/--table [table]</code>：表示这条规则作用在哪个表上</li><li><code>-A/--append [chain]</code>：表示给这个链添加一条规则</li><li><code>-p/--protocol [protocol]</code>：表示处理哪个协议</li><li><code>-j/--jump [target]</code>：表示跳转到哪个目标</li></ul><p>比如上面的第一条命令表示，在 OUTPUT 链上的 tcp 协议都跳转到 MARK 并标记个 23。 此时被标记为 23 的数据包会重新走到 PROROUTING 链上。</p><blockquote><p>tproxy 仅能处理 tcp 和 udp，所以这里只标记这两个协议。</p></blockquote><h2 id="使用-chain-管理数据包" tabindex="-1"><a href="#使用-chain-管理数据包">#</a> 使用 chain 管理数据包 <a class="header-anchor" href="#使用-chain-管理数据包" aria-label="Permalink to &quot;[#](#使用-chain-管理数据包) 使用 chain 管理数据包&quot;">​</a></h2><p>上面的规则虽然完成了重回 PREROUTING 的能力，但有些数据包应当直接从 OUTPUT 链出去，比如访问网关管理页面（192.168.22.1），或者是 NAS 的 192.168.22.2。所以我们需要跳过一部分的数据包避免标记上 23。</p><p><code>-d/--destination [address]</code> 表示匹配对应的 ip（范围），上面的命令则是在 OUTPUT 链上，如果是发往 192.168.0.0/16 的数据包，则直接返回。这一条命令要在前面的 <code>-j MARK</code> 命令之前执行，匹配规则会根据创建的规则顺序按顺序执行。</p><p>如下，这表示去往非 192.168.0.0/16 的 tcp/udp 数据包标记 23：</p><p>此时我们可以思考一下 OUTPUT 链 “本质” 是什么： <strong>写 iptables 的规则，就是在写代码，OUTPUT 链是程序内置的函数，它会在对应时机调用，我们需要做是填充这个函数的逻辑。（匹配规则就是 if else）</strong> <strong>所以，链 = 函数。这就清晰很多了。</strong> iptables 还给我们提供了创建自定义链（函数）的能力，有了自定义链（函数）我们可以更好地管理规则。</p><p>对于上面的 OUTPUT 管理，我们可以改写成：</p><p><code>-N/--new-chain [chain]</code> 表示创建一个新的链。</p><p>我们创建了一个自定义链 <code>LOCAL_DIVERT</code>，接下来需要跳转到这个链（调用这个函数）：</p><blockquote><p>你也可以带着这个函数的感觉，理解一下 ACCEPT。</p></blockquote><p>当不需要这些规则时，你可以删除相关的链和规则： 比如：</p><p>这会删除对应的一条规则。<strong>删除的逻辑我们需要捋清楚，当关闭 tproxy 时，全删除不是合理做法，特别是你还写了一些其他规则，比如限制指定应用联网。</strong></p><p>当不需要 <code>LOCAL_DIVERT</code> 时，我们可以通过以下命令删除（要小心翼翼）：</p><p>三条命令首先删除跳转（调用）的引用，然后删除 <code>LOCAL_DIVERT</code> 中的<strong>全部规则</strong>，然后删除 <code>LOCAL_DIVERT</code> 这个链。</p><p>以上几个缩写为：</p><ul><li><code>-D/--delete</code>：从一个链上删除指定的规则</li><li><code>-F/--flush [chain]</code>：清空一个链上所有规则</li><li><code>-X/--delete-chain [chain]</code>：删除一个链</li></ul><h2 id="应用-tproxy" tabindex="-1"><a href="#应用-tproxy">#</a> 应用 tproxy <a class="header-anchor" href="#应用-tproxy" aria-label="Permalink to &quot;[#](#应用-tproxy) 应用 tproxy&quot;">​</a></h2><p>有了以上的内容，我们可以开始把数据发的 tproxy，tproxy 翻译过来就是内核提供的透明代理能力。 这里我们使用 <a href="https://github.com/Dreamacro/clash" target="_blank" rel="noreferrer">clash (opens new window)</a> 接管 tproxy 的流量。 根据 clash 的文档，假定我们设置的 tproxy 端口为 22223，如下命令可以将数据包通过 tproxy 发给 clash：</p><blockquote><p>如果你看过一些文档，可能注意到 <code>--tproxy-mark</code> 参数，这个参数会给跳转到 TPROXY 的数据包进行一个标记，你可以用这个标记处理后续的判断，一般可以用来判断回环流量（很快我们就会遇到这个问题）。</p></blockquote><p>记得创建自定义的链，上面的两行命令 PREROUTING 在增加更多的规则后会很难管理。</p><p>当前完整的 iptables 命令如下：</p><p>你可能注意到这里第二行多了个命令，记得<strong>有来有回</strong>，回来的数据包不能再走一次 tproxy 了！由于我们的本机 IP 为 192.168.22.33，在这个范围内，上面的规则看起来没什么问题。</p><p>实际上这些规则是不能用的，看起来没问题，但<strong>从 clash 出来的数据包呢？</strong> 上面的规则会变成：</p><ul><li>本机发出来去往外网的数据包通过 mark 回到 PREROUTING</li><li>通过 tproxy 进入 clash</li><li>本机 clash 发出来去往外网的数据包通过 mark 回到 PREROUTING</li><li>通过 tproxy 进入 clash</li><li>本机 clash 发出来去往外网的数据包通过 mark 回到 PREROUTING</li><li>通过 tproxy 进入 clash</li><li>本机 clash 发出来去往外网的数据包通过 mark 回到 PREROUTING</li><li>.....</li></ul><h2 id="解决回环问题" tabindex="-1"><a href="#解决回环问题">#</a> 解决回环问题 <a class="header-anchor" href="#解决回环问题" aria-label="Permalink to &quot;[#](#解决回环问题) 解决回环问题&quot;">​</a></h2><p>这里产生了一个回环，我们需要解决掉，即<strong>让本机 clash 发出来的数据包直接从 OUTPUT 链出去吧</strong>。</p><p>根据文末的一些文档，通过 mark 匹配的性能似乎不太好（我没有去验证）。我们采取另一种方式，通过 gid/uid 绕过回环。</p><p>思路：由于 Linux 的多用户模式，我们可以让一个单独的用户启动 clash，然后利用 iptables 中匹配 gid/uid 的功能绕过回环，当是 clash 对应的用户的流量，直接从 OUTPUT 链出去。</p><p>使用以下命令可以创建一个名为 clash，uid 为 0，gid 为 23333 的用户：</p><p>使用如下命令可以验证创建的用户是否正常：</p><p>接下来我们使用这个用户启动 clash：</p><p>iptables 执行在 OUTPUT 链改为如下命令：</p><p><code>-m/-match</code> 表示匹配对应的策略，上面的命令则是在 OUTPUT 链 gid 非 23333 的数据包跳转到 LOCAL_DIVERT。</p><h2 id="clash-使用-tproxy-需要劫持-dns" tabindex="-1"><a href="#clash-使用-tproxy-需要劫持-dns">#</a> clash 使用 tproxy 需要劫持 DNS <a class="header-anchor" href="#clash-使用-tproxy-需要劫持-dns" aria-label="Permalink to &quot;[#](#clash-使用-tproxy-需要劫持-dns) clash 使用 tproxy 需要劫持 DNS&quot;">​</a></h2><p>使用 clash 的 tproxy 能力时，需要让 clash 接管 DNS 流量（似乎是用来判断路由规则？），有两种方式：</p><ul><li>停掉本地的 DNS 服务，将 clash 的 DNS 服务端口改为 53</li><li>将 DNS 查询数据包转发到 clash</li></ul><p>这里我们采取第二种：</p><p>1053 是在 clash 上设置的 DNS 服务端口。 <code>-I/--insert [chain] [rule index]</code> 表示插入一条规则到指定位置，默认为 1，表示插入到规则的第一条。这里使用 <code>-I</code> 是避免后续我们添加更多的 iptables 规则后，影响到 DNS 数据包转发。</p><p>记得这里同样需要<strong>仅拦截来自非 clash 的数据</strong>。</p><p>有了以上的配置，我们已经可以完成基本的操作：<strong>将本机发往外网的数据通过 tproxy 经过 clash 发出</strong>，并避免数据回来时又通过 tproxy 进入 clash。</p><h2 id="绕过更多内网-ip-段" tabindex="-1"><a href="#绕过更多内网-ip-段">#</a> 绕过更多内网 IP 段 <a class="header-anchor" href="#绕过更多内网-ip-段" aria-label="Permalink to &quot;[#](#绕过更多内网-ip-段) 绕过更多内网 IP 段&quot;">​</a></h2><p>还差一步，这些配置就可以用了，上面的操作中，发往 127.0.0.1:1053 的 DNS 查询数据包会通过 OUTPUT 链回到 PREROUTING 最后进入到 tproxy。 我们可以在 OUTPUT 链跳过去：</p><p>回来数据包仍然经过 PREROUTING，同样需要跳过：</p><p>我们还有更多的内网/特殊 IP 段需要直接 RETURN，完整列表如下：</p><p>由于到这一步，我们完成了最基本的配置，避免影响阅读全部的内容，我将当前的完整配置记录到 <a href="https://gist.github.com/DianQK/25cf82bff5136068b98575adef598f82#file-iptables_1-sh" target="_blank" rel="noreferrer">Gist (opens new window)</a>。</p><p>此时在访问外网网站时，应当可以看到 clash 中的日志，也可以看到数据正常返回（curl 成功、网站加载成功）。 如果没有，注意检查上述有哪些地方有错或是漏了，比如 ip rule/route 的丢失。</p><h2 id="访问家里内网" tabindex="-1"><a href="#访问家里内网">#</a> 访问家里内网 <a class="header-anchor" href="#访问家里内网" aria-label="Permalink to &quot;[#](#访问家里内网) 访问家里内网&quot;">​</a></h2><p>这部分要基于 <a href="https://www.bilibili.com/read/cv9219407" target="_blank" rel="noreferrer">使用 Shadowsocks 访问家庭内网 (opens new window)</a> 完成，你需要先搭建一个 ss-server 供你在其他网络环境下访问家里内网。 这个场景下有一个问题，<strong>如何在家直连，在外面走 SS？</strong> 文章中给出了一个能用但不够优雅的方案，将家里的 DNS 服务把域名指向内网 IP，不管在哪里，流量都经过 clash。这可能带来一些问题，upnp 等需要直接连接的内网流量异常（只是可能，我还不确定）。 接下来我们来看看如何解决这个问题，初步的想法可能是监听 IP 变化，如果在家里内网，访问内网的数据包都不要在 OUTPUT 链打标记，如果在外面，当作外网一样处理。这么处理太麻烦了，实际上我们可以通过 iptables 的匹配规则完成（iptables 可以曲线完成 if else）。</p><p>首先看 OUTPUT 链，这个相对简单一些，如果来源 IP 不在家里内网段（192.168.22.0/24），同时目标 IP 是家里内网段，打标记。</p><blockquote><p>! 表示非，同时注意该规则需要应用在 <code>-d 192.168.0.0/16</code> 的前面。</p></blockquote><p>配置之后，如下的几种场景结果为：</p><ul><li>家里内网环境，访问内网，不会跳转到 LOCAL_INTRANET_DIVERT，因为来源 IP 在内网段</li><li>家里内网环境，访问外网，不会跳转到 LOCAL_INTRANET_DIVERT，因为目标 IP 不在内网段</li><li>非家里内网环境，访问内网，跳转到 LOCAL_INTRANET_DIVERT</li><li>非家里内网环境，访问外网，不会跳转到 LOCAL_INTRANET_DIVERT，因为目标 IP 不在内网段</li></ul><p>非常棒！</p><blockquote><p>接下来可能会很绕，而且我可能阐述的不太清楚，需要多理解分析这里的各种场景。</p></blockquote><p>接下来我们看 PREROUTING 链的处理，这个比较复杂，我们需要处理以下几种场景：</p><ul><li>从 OUTPUT 链来的数据包，目标 IP 为外网</li><li>从 OUTPUT 链来的数据包，目标 IP 为家里内网</li><li>响应回来的数据包，目标 IP 为本机 IP</li></ul><p>事实上这里有很多种处理的方式，比如在 OUTPUT 链上打一个不同的标记，比如 33，然后在 PREROUTING 链匹配。这里我选择继续用 IP 匹配。</p><p>考虑到一份配置可能应用到多个设备中（或者一台设备的 IP 会变化），我们先看这种场景的处理：</p><p>先进行第一步过滤，如果在 <strong>PREROUTING</strong> 链来源 IP 不是内网，<strong>目标 IP 是内网</strong>，接下来还有以下几种情况需要处理：</p><ul><li>设备处于家里内网环境，这是响应回来的数据，此时来源 IP 应当为外网 IP</li><li>设备处于其他环境，这是从 OUTPUT 链来的数据，此时来源 IP 应当为其他内网 IP</li></ul><p>我们需要在 INTRANT_DIVERT 链中进行过滤，当来源 IP 为内网时，走 tproxy（注意前面已经确保了来源 IP 不是家里内网）：</p><p>此时配置已经完成了，不过你可以会有疑问，在其他内网环境下，访问自身所在的内网环境怎么办？ 注意前面的这一条规则：</p><p>如果在其他内网环境（比如 192.168.1.0/24），在该内网环境下，设备 IP 可能为 <code>192.168.1.56</code>，访问该内网回来的数据包的目标 IP 为 <code>192.168.1.56</code>，并不会匹配到这条规则进入 INTRANT_DIVERT。</p><h2 id="解决其他网络环境下查询内网-dns-问题" tabindex="-1"><a href="#解决其他网络环境下查询内网-dns-问题">#</a> 解决其他网络环境下查询内网 DNS 问题 <a class="header-anchor" href="#解决其他网络环境下查询内网-dns-问题" aria-label="Permalink to &quot;[#](#解决其他网络环境下查询内网-dns-问题) 解决其他网络环境下查询内网 DNS 问题&quot;">​</a></h2><p>虽然 iptables 的规则都完成了，但还不能解决在其他网络环境下访问内网的问题，可以看到这里我们都是基于 IP 进行的判断，在其他网络环境下，根本查询不到 NAS 使用的域名对应的 IP。因为查询不到 IP，第一步的 DNS 查询就失败了，也无法走到后面的 IP 匹配。 此时只能通过 IP 访问内网环境。</p><p>为了解决这个问题，我们可以使用以下两个方法：</p><ul><li>在公网 DNS 服务配置映射规则，这是可以的，反正映射到内网 IP，还是安全的</li><li>在 clash 的 hosts 中配置映射规则</li></ul><p>此时应当可以看到，在家访问内网服务，clash 没有访问日志，在外面访问内网服务，可以看到数据经过了 clash。</p><p>到这一步，我们完成了所有的配置，我将当前的完整配置记录到 <a href="https://gist.github.com/DianQK/25cf82bff5136068b98575adef598f82#file-iptables_2-sh" target="_blank" rel="noreferrer">Gist (opens new window)</a>。</p><h2 id="兼容-fake-ip-场景" tabindex="-1"><a href="#兼容-fake-ip-场景">#</a> 兼容 fake-ip 场景 <a class="header-anchor" href="#兼容-fake-ip-场景" aria-label="Permalink to &quot;[#](#兼容-fake-ip-场景) 兼容 fake-ip 场景&quot;">​</a></h2><p>clash 的 DNS 服务有两种类型，一种是 redir-host，另一种是 fake-ip，上述例子一直介绍的是 redir-host。 在这种类型下，所有 DNS 解析在本机完成，这可能遇到一些 DNS 污染问题，同时使用 fake-ip 让 DNS 解析在远程服务器完成会更快一些。</p><p>从使用上 fake-ip 的原理差不多是这个样子，首先定义一个 Fake IP 池（198.18.0.1/16），所有的 DNS 查询服务都直接返回这个池子里的 IP，此时可以做到如果通过域名匹配到某条规则不是直连，可以将 DNS 放到远程服务器解析，借此解决 DNS 污染问题。</p><p>这种场景下，因为所有返回的（目标） IP 都变成了 198.18.0.1/16，我们无法区分是内网还是外网，我们需要更新一下 clash 的配置，在 DNS 服务中，提供了 <code>fake-ip-filter</code> 参数，在这里面的域名将保持在本地查询 DNS 同时返回真实的 IP。</p><p>iptables 规则可以（这不是必要操作）做适当调整：</p><p>需要注意的时，当增加 <code>-d 198.18.0.0/16</code> 时，一些通过 IP 连接的服务不会走到 tproxy。（比如 Telegram 直连外网 IP，这种情况自然匹配不到 <code>198.18.0.0/16</code>）。</p><h2 id="稍微改改" tabindex="-1"><a href="#稍微改改">#</a> 稍微改改 <a class="header-anchor" href="#稍微改改" aria-label="Permalink to &quot;[#](#稍微改改) 稍微改改&quot;">​</a></h2><p>对上述规则我们还可以再走一步，当我们在家里内网环境下，访问外网服务时，响应回来时，INTRANT_DIVERT 中的规则总会被尝试匹配。</p><p>有两种可行的解决办法：</p><ol><li>固定本机 IP，这样就可以增加一条规则，目标 IP 为本机 IP 时，永远直接 RETURN</li><li>固定要访问的内网 IP，比如指定 192.168.22.1/28 为需要访问的内网段，然后本机 IP 不要分配到这个网段</li></ol><h2 id="参考内容" tabindex="-1"><a href="#参考内容">#</a> 参考内容 <a class="header-anchor" href="#参考内容" aria-label="Permalink to &quot;[#](#参考内容) 参考内容&quot;">​</a></h2><p>以上配置满足了我的使用需求，但很多内容的介绍并不准确，比如 NAT 只使用 IP 做转换是不够的，tproxy 和 REDIRECT 之间有什么区别？</p><p>多亏以下参考内容，我才能完成本次的 iptables 应用：</p><ol><li><a href="https://www.oreilly.com/library/view/linux-iptables-pocket/9780596801861/" target="_blank" rel="noreferrer">Linux iptables Pocket Reference (opens new window)</a></li><li><a href="https://en.wikipedia.org/wiki/Network_address_translation" target="_blank" rel="noreferrer">Network address translation (opens new window)</a></li><li><a href="https://linux.die.net/man/8/iptables" target="_blank" rel="noreferrer">iptables(8) - Linux man page (opens new window)</a></li><li><a href="https://www.kernel.org/doc/html/latest/networking/tproxy.html" target="_blank" rel="noreferrer">Transparent proxy support (opens new window)</a></li><li><a href="https://guide.v2fly.org/app/tproxy.html" target="_blank" rel="noreferrer">新 V2Ray 白话文指南 - 透明代理(TPROXY) (opens new window)</a></li><li><a href="https://xtls.github.io/document/level-2/iptables_gid.html" target="_blank" rel="noreferrer">透明代理通过 gid 规避 Xray 流量 (opens new window)</a></li><li><a href="https://github.com/Dreamacro/clash/issues/1684" target="_blank" rel="noreferrer">[求助] 透明代理时Tproxy模式代理自身流量问题 (opens new window)</a></li><li><a href="https://blog.csdn.net/qq_21125183/article/details/86487747" target="_blank" rel="noreferrer">计算机网络：NAT基本原理 (opens new window)</a></li><li><a href="https://serverfault.com/questions/375981/delete-a-iptables-chain-with-its-all-rules" target="_blank" rel="noreferrer">Delete a iptables chain with its all rules (opens new window)</a></li><li><a href="https://www.digitalocean.com/community/tutorials/how-to-list-and-delete-iptables-firewall-rules" target="_blank" rel="noreferrer">How To List and Delete Iptables Firewall Rules (opens new window)</a></li></ol><p>最后你还可以把这套方案应用的 Android 上。 对了，如果你遇到 Arch/Manjaro 下提示的网络问题，那是 clash 的 fake-ip 模式不会响应 ICMP 协议 。你可以从 <a href="https://wiki.archlinux.org/title/NetworkManager#Checking_connectivity" target="_blank" rel="noreferrer">Checking connectivity (opens new window)</a> 找到其中一种解决方法。 如果你想了解更多关于 iptables 内容，参考内容的第一条是一本很适合上手的书。 如果你想了解如何开机启动，参考内容的第 5、6 条会有一些帮助。</p></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-d4a0bba5><!--[--><!--]--><div class="edit-info" data-v-d4a0bba5><div class="edit-link" data-v-d4a0bba5><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/kpa32/github_blog/edit/main/docs/post/未分类/使用-iptables-的-tproxy-完成本机访问家里内网的透明代理.md" target="_blank" rel="noreferrer" data-v-d4a0bba5><!--[--><span class="vpi-square-pen edit-link-icon" data-v-d4a0bba5></span> 在 GitHub 上编辑此页面<!--]--></a></div><div class="last-updated" data-v-d4a0bba5><p class="VPLastUpdated" data-v-d4a0bba5 data-v-7e05ebdb>最近更新时间: <time datetime="2024-05-02T05:37:45.000Z" data-v-7e05ebdb></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-d4a0bba5><span class="visually-hidden" id="doc-footer-aria-label" data-v-d4a0bba5>Pager</span><div class="pager" data-v-d4a0bba5><a class="VPLink link pager-link prev" href="/post/未分类/win10远程共享文件夹.html" data-v-d4a0bba5><!--[--><span class="desc" data-v-d4a0bba5>上一篇</span><span class="title" data-v-d4a0bba5>win10远程共享文件夹</span><!--]--></a></div><div class="pager" data-v-d4a0bba5><a class="VPLink link pager-link next" href="/post/未分类/博客设置相关.html" data-v-d4a0bba5><!--[--><span class="desc" data-v-d4a0bba5>下一篇</span><span class="title" data-v-d4a0bba5>博客设置相关</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-ad552957 data-v-e315a0ad><div class="container" data-v-e315a0ad><p class="message" data-v-e315a0ad>MIT Licensed | Copyright © 2024-present <a href='https://kpa32.github.io'><b>Kpa</b></a></p><p class="copyright" data-v-e315a0ad>Powered by <a href='https://vitepress.dev/'><b>VitePress - 1.1.4</b></a></p></div></footer><!--[--><!--]--></div></div>
    
    
  </body>
</html>