import{_ as s,o as i,c as a,a6 as n}from"./chunks/framework.DnJfIKBR.js";const C=JSON.parse('{"title":"AOSP代码环境配置","description":"","frontmatter":{"title":"AOSP代码环境配置","layout":"doc","navbar":true,"sidebar":true,"aside":false},"headers":[],"relativePath":"post/AOSP/AOSP-Pixel3-内核编译支持 eBPF.md","filePath":"post/AOSP/AOSP-Pixel3-内核编译支持 eBPF.md","lastUpdated":1718396635000}'),h={name:"post/AOSP/AOSP-Pixel3-内核编译支持 eBPF.md"},l=n(`<p>#ASOP内核编译</p><h2 id="查看手机信息" tabindex="-1">查看手机信息 <a class="header-anchor" href="#查看手机信息" aria-label="Permalink to &quot;查看手机信息&quot;">​</a></h2><table><thead><tr><th>信息类型</th><th>命令</th><th>示例输出</th></tr></thead><tbody><tr><td>设备型号</td><td><code>adb shell getprop ro.product.model</code></td><td>Pixel 3</td></tr><tr><td>设备品牌</td><td><code>adb shell getprop ro.product.brand</code></td><td>google</td></tr><tr><td>设备制造商</td><td><code>adb shell getprop ro.product.manufacturer</code></td><td>Google</td></tr><tr><td>操作系统版本</td><td><code>adb shell getprop ro.build.version.release</code></td><td>12</td></tr><tr><td>硬件信息</td><td><code>adb shell getprop ro.hardware</code></td><td>blueline</td></tr><tr><td>产品名称</td><td><code>adb shell getprop ro.product.name</code></td><td>raven</td></tr><tr><td>Build ID</td><td><code>adb shell getprop ro.build.id</code></td><td>SP1A.210812.016.C2</td></tr><tr><td>构建版本号</td><td><code>adb shell getprop ro.build.version.incremental</code></td><td>8618562</td></tr><tr><td>构建描述</td><td><code>adb shell getprop ro.build.description</code></td><td>blueline-user 12 SP1A.210812.016.C2 8618562 release-keys</td></tr><tr><td>构建日期</td><td><code>adb shell getprop ro.build.date</code></td><td>Thu May 19 23:02:57 UTC 2022</td></tr><tr><td>内核版本</td><td><code>uname -a</code></td><td>Linux localhost 4.9.270-g862f51bac900-ab7613625 #0 SMP PREEMPT Thu Aug 5 07:04:42 UTC 2021 aarch64</td></tr></tbody></table><h2 id="根据build-id-获取pixel系列手机对应的aosp分支" tabindex="-1">根据build id 获取pixel系列手机对应的aosp分支 <a class="header-anchor" href="#根据build-id-获取pixel系列手机对应的aosp分支" aria-label="Permalink to &quot;根据build id 获取pixel系列手机对应的aosp分支&quot;">​</a></h2><p><a href="https://source.android.com/docs/setup/about/build-numbers?hl=zh-cn" target="_blank" rel="noreferrer">https://source.android.com/docs/setup/about/build-numbers?hl=zh-cn</a></p><table><thead><tr><th>Build Id</th><th>标记</th><th>版本</th><th>支持的设备</th><th>安全补丁级别</th></tr></thead><tbody><tr><td>SP1A.210812.016.C2</td><td>android-12.0.0_r34</td><td>Android12</td><td>Pixel 3、Pixel 3 XL</td><td>2021-10-05</td></tr></tbody></table><p>搜索build id获取驱动 <a href="https://developers.google.cn/android/drivers?hl=zh-cn" target="_blank" rel="noreferrer">https://developers.google.cn/android/drivers?hl=zh-cn</a></p><p>搜索 pixel3 + android 12 获取对应的刷机镜像 <a href="https://developers.google.cn/android/images?hl=zh-cn" target="_blank" rel="noreferrer">https://developers.google.cn/android/images?hl=zh-cn</a></p><p>检索Piexl3对应的内核版本代号 <a href="https://source.android.com/docs/setup/build/building-pixel-kernels?hl=zh-cn" target="_blank" rel="noreferrer">https://source.android.com/docs/setup/build/building-pixel-kernels?hl=zh-cn</a><a href="https://source.android.com/docs/setup/build/building-pixel-kernels?hl=zh-cn#legacy-kernel-branches" target="_blank" rel="noreferrer">https://source.android.com/docs/setup/build/building-pixel-kernels?hl=zh-cn#legacy-kernel-branches</a></p><table><thead><tr><th>设备</th><th>AOSP 树中的二进制文件路径</th><th>仓库分支</th></tr></thead><tbody><tr><td>Pixel 3 (blueline) Pixel 3 XL (crosshatch)</td><td>device/google/crosshatch-kernel</td><td>android-msm-crosshatch-4.9-android12</td></tr></tbody></table><h3 id="编译软件" tabindex="-1">编译软件 <a class="header-anchor" href="#编译软件" aria-label="Permalink to &quot;编译软件&quot;">​</a></h3><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> git-core</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gnupg</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> flex</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bison</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build-essential</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zlib1g-dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gcc-multilib</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> g++-multilib</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libc6-dev-i386</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libncurses5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lib32ncurses5-dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> x11proto-core-dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libx11-dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lib32z1-dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libgl1-mesa-dev</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libxml2-utils</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> xsltproc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> unzip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fontconfig</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">##/home/kpa/pixel3_kernel/private/msm-google/scripts/extract-cert.c:21:10: fatal error: &#39;openssl/bio.h&#39; file not found</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#include &lt;openssl/bio.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#安装ssl可解决</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libssl-dev</span></span></code></pre></div><h3 id="下载内核源码" tabindex="-1">下载内核源码 <a class="header-anchor" href="#下载内核源码" aria-label="Permalink to &quot;下载内核源码&quot;">​</a></h3><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#下载源码切换到对应分支</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pixel3_kernel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pixel3_kernel</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">repo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> git://mirrors.ustc.edu.cn/aosp/kernel/manifest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> android-msm-crosshatch-4.9-android12</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">repo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sync</span></span></code></pre></div><h3 id="添加编译工具" tabindex="-1">添加编译工具 <a class="header-anchor" href="#添加编译工具" aria-label="Permalink to &quot;添加编译工具&quot;">​</a></h3><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/pixel3_kernel/prebuilts</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://android.googlesource.com/kernel/prebuilts/build-tools</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build-tools</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kernel-build-tools</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/pixel3_kernel/prebuilts/kernel-build-tools/linux-x86/bin:$PATH</span></span></code></pre></div><h3 id="同步到和手机一样的commit" tabindex="-1">同步到和手机一样的commit <a class="header-anchor" href="#同步到和手机一样的commit" aria-label="Permalink to &quot;同步到和手机一样的commit&quot;">​</a></h3><p><code>4.9.270-g862f51bac900-ab7613625 </code> g后面的数字<code>862f51bac900</code>就是commit</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/pixel3_kernel/private/msm-google</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> checkout</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 862f51bac900</span></span></code></pre></div><h3 id="解包boot-img" tabindex="-1">解包Boot Img <a class="header-anchor" href="#解包boot-img" aria-label="Permalink to &quot;解包Boot Img&quot;">​</a></h3><p><strong>无ASOP源码编译，需要合并原厂的驱动进来</strong></p><p>下载刷机镜像解包</p><p>这个工具要在windows上用 Android-Image-Kitchen 我用了下不能解包pixel3</p><p>这里参阅了下KernelSu的文档使用了magiskboot_build <a href="https://github.com/osm0sis/Android-Image-Kitchen" target="_blank" rel="noreferrer">https://github.com/osm0sis/Android-Image-Kitchen</a><a href="https://kernelsu.org/zh_CN/guide/installation.html" target="_blank" rel="noreferrer">https://kernelsu.org/zh_CN/guide/installation.html</a><a href="https://github.com/ookiineko/magiskboot_build/releases/tag/last-ci" target="_blank" rel="noreferrer">https://github.com/ookiineko/magiskboot_build/releases/tag/last-ci</a></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pixel3\\blueline-sp1a.210812.016.c2\\magiskboot</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">magiskboot.exe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> unpack</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">oot.img</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Parsing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> boot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> image:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">oot.img]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HEADER_VER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [2]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">KERNEL_SZ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       [19835242]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RAMDISK_SZ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [14206167]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SECOND_SZ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       [0]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RECOV_DTBO_SZ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   [0]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DTB_SZ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          [863100]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">OS_VERSION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [12.0.0]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">OS_PATCH_LEVEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [2021-10]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PAGESIZE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        [4096]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            []</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CMDLINE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         [console=ttyMSM0,115200n8 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">androidboot.console=ttyMSM0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> printk.devkmsg=on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> msm_rtb.filter=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0x237</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ehci-hcd.park=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> service_locator.enable=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cgroup.memory=nokmem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lpm_levels.sleep_disabled=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usbcore.autosuspend=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> loop.max_part=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> androidboot.boot_devices=soc/1d84000.ufshc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> androidboot.super_partition=system</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvariant=user]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CHECKSUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        [3cf8dcecd74daab132c9561129cdd59b5ab4e972000000000000000000000000]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">KERNEL_FMT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [lz4]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RAMDISK_FMT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">     [gzip]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unexpected</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ASN.1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> expected</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SEQUENCE,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> got</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> APPLICATION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [1] (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">primitive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">VBMETA</span></span></code></pre></div><p>解压后得到一个 <code>ramdisk.cpio</code> 复制到 <code>~/pixel3_kernel</code>目录下</p><p>使用官方解压工具解压</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kpa@ubuntu:~/pixel3_kernel/tools/mkbootimg$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./unpack_bootimg.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --boot_img</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> boot.img</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --out</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vendor_boot_out</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">boot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> magic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ANDROID!</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel_size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19835242</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> load</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> address:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x00008000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ramdisk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 14206167</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ramdisk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> load</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> address:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x01000000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">second</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bootloader</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">second</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bootloader</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> load</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> address:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x00000000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tags</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> load</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> address:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x00000100</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">page</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4096</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">os</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> version:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 12.0.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">os</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> patch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> level:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2021-10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">boot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> image</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> header</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> version:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">product</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">command</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> line</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> args:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> console=ttyMSM0,115200n8</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> androidboot.console=ttyMSM0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> printk.devkmsg=on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> msm_rtb.filter=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0x237</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ehci-hcd.park=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> service_locator.enable=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cgroup.memory=nokmem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lpm_levels.sleep_disabled=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usbcore.autosuspend=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> loop.max_part=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> androidboot.boot_devices=soc/1d84000.ufshc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> androidboot.super_partition=system</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildvariant=user</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">additional</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> line</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> args:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">recovery</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dtbo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">recovery</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dtbo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> offset:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x0000000000000000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">boot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> header</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1660</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dtb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 863100</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dtb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> address:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0x0000000001f00000</span></span></code></pre></div><p>解压后得到一个 <code>ramdisk</code> 复制到 <code>~/pixel3_kernel</code>目录下</p><h3 id="添加mkbooting文件" tabindex="-1">添加mkbooting文件 <a class="header-anchor" href="#添加mkbooting文件" aria-label="Permalink to &quot;添加mkbooting文件&quot;">​</a></h3><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#build/build.sh 需要这个脚本，源码里没有</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-z</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MKBOOTIMG_PATH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    MKBOOTIMG_PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;tools/mkbootimg/mkbootimg.py&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$MKBOOTIMG_PATH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mkbootimg.py script not found. MKBOOTIMG_PATH = </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$MKBOOTIMG_PATH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span></code></pre></div><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/pixel3_kernel</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tools</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tools</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://android.googlesource.com/platform/system/tools/mkbootimg</span></span></code></pre></div><h3 id="修改build-build-sh" tabindex="-1">修改build/build.sh <a class="header-anchor" href="#修改build-build-sh" aria-label="Permalink to &quot;修改build/build.sh&quot;">​</a></h3><p>找到 <code>~/pixel_kernel/build/build.sh</code></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-z</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SKIP_CP_KERNEL_HDR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ] ; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;========================================================&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  KERNEL_HEADERS_TAR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\${DIST_DIR}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/kernel-headers.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot; Copying kernel headers to \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KERNEL_HEADERS_TAR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  pushd $ROOT_DIR/$KERNEL_DIR</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    find</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> arch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> include</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $OUT_DIR </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-name</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.h</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -print0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">               \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -czf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $KERNEL_HEADERS_TAR                     </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              --absolute-names</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                                 \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              --dereference</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                                    \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              --transform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;s,.*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$OUT_DIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,,&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                     \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              --transform</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;s,^,kernel-headers/,&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">               \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">              --null</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -T</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  popd</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#++修改部分 添加以下内容</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">VENDOR_RAMDISK_BINARY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  cp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${VENDOR_RAMDISK_BINARY} \${DIST_DIR}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fi</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#++修改部分</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;========================================================&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot; Files copied to \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DIST_DIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span></span></code></pre></div><h3 id="配置编译变量" tabindex="-1">配置编译变量 <a class="header-anchor" href="#配置编译变量" aria-label="Permalink to &quot;配置编译变量&quot;">​</a></h3><p><code>~/pixel_kernel/build_bluecross.sh</code> 软连接到真实的文件是 <code>~/pixel_kernel/private/msm-google/build_bluecross.sh</code></p><p>修改 <code>~/pixel_kernel/build_bluecross.sh</code> 如下配置</p><p>需要根据解包的内容修改</p><p><code>MKBOOTIMG_PATH</code> 对应刚才下载的工具 <code>BASE_ADDRESS</code> 对应解包<code>kernel load address: 0x00008000</code></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BUILD_CONFIG</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">private/msm-google/build.config.bluecross_no-cfi</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    BUILD_BOOT_IMG=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    MKBOOTIMG_PATH=&quot;tools/mkbootimg/mkbootimg.py&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    VENDOR_RAMDISK_BINARY=ramdisk</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    KERNEL_BINARY=Image.lz4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    BOOT_IMAGE_HEADER_VERSION=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    KERNEL_CMDLINE=&quot;console=ttyMSM0,115200n8 androidboot.console=ttyMSM0 printk.devkmsg=on msm_rtb.filter=0x237 ehci-hcd.park=3 service_locator.enable=1 cgroup.memory=nokmem lpm_levels.sleep_disabled=1 usbcore.autosuspend=7 loop.max_part=7 androidboot.boot_devices=soc/1d84000.ufshc androidboot.super_partition=system buildvariant=user&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    BASE_ADDRESS=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0x00008000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    PAGE_SIZE=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4096</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    build/build.sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span></code></pre></div><h3 id="尝试编译" tabindex="-1">尝试编译 <a class="header-anchor" href="#尝试编译" aria-label="Permalink to &quot;尝试编译&quot;">​</a></h3><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#尝试编译下</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./build_bluecross.sh</span></span></code></pre></div><p>卡在 LTO vmlinux.o CPU不转了<br> 再次执行 <code>./build_bluecross.sh V=1</code> 输出详细的日志 然后查资料看了半天，又继续编译下去了 编译很慢,耐心等待吧</p><p>碰见了python错误，检查了下当前用的是python 2.7 升级下python到3+版本</p><div class="language-log vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">log</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+ python tools/mkbootimg/mkbootimg.py --kernel /home/kpa/pixel3_kernel/out/android-msm-pixel-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">9</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/dist/Image.lz4 --header_version </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --base </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0x00008000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --pagesize </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4096</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --cmdline </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;console=ttyMSM0,115200n8 androidboot.console=ttyMSM0 printk.devkmsg=on msm_rtb.filter=0x237 ehci-hcd.park=3 service_locator.enable=1 cgroup.memory=nokmem lpm_levels.sleep_disabled=1 usbcore.autosuspend=7 loop.max_part=7 androidboot.boot_devices=soc/1d84000.ufshc androidboot.super_partition=system buildvariant=user&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> --dtb /home/kpa/pixel3_kernel/out/android-msm-pixel-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">9</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/dist/dtb.img --ramdisk /home/kpa/pixel3_kernel/out/android-msm-pixel-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">9</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/dist/ramdisk.gz -o /home/kpa/pixel3_kernel/out/android-msm-pixel-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">9</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/dist/boot.img</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  File </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;tools/mkbootimg/mkbootimg.py&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, line </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">120</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    args.output.write</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pack(f&#39;{BOOT_MAGIC_SIZE}s&#39;, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">BOOT_MAGIC.encode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                                               ^</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SyntaxError: invalid syntax</span></span></code></pre></div><p>修改~/pixel_kernel/build/build.sh 中 <code>python</code> 换成<code>python3</code></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -x</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">python3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$MKBOOTIMG_PATH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DIST_DIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KERNEL_BINARY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    --header_version</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BOOT_IMAGE_HEADER_VERSION</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MKBOOTIMG_ARGS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]}&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DIST_DIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}/boot.img&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> +x</span></span></code></pre></div><p>编译后输出，表示成功了 <code>boot image created at /home/kpa/pixel3_kernel/out/android-msm-pixel-4.9/dist/boot.img</code></p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">adb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reboot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bootloader</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fastboot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> devices</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#写入手机</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#这个是临时的，重启就恢复，建议测试下没问题</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fastboot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> boot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> boot.img</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#这个是永久的 慎用，确认编译无误后，在进行烧写</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fastboot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> flash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> boot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> boot.img</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#确认版本，写入成功</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> adb shell</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">blueline:/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /proc/version</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Linux</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> version</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 4.9.270-dirty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (kpa@ubuntu) (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Android</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (7284624, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">based</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> r416183b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) clang version 12.0.5 (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">https://android.googlesource.com/toolchain/llvm-project</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> c935d99d7cf2016289302412d708641d52d2f7ee</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#1 repo:android-msm-crosshatch-4.9-android12 SMP PREEMPT Fri Jun</span></span></code></pre></div><h3 id="开启内核选项" tabindex="-1">开启内核选项 <a class="header-anchor" href="#开启内核选项" aria-label="Permalink to &quot;开启内核选项&quot;">​</a></h3><p>查看源码目录下build.config <code>DEFCONFIG=b1c1_defconfig</code> 这里对应的 bluecross的配置文件路径在 <code>~/pixel_kernel/private/msm-google/arch/arm64/configs/b1c1_defconfig</code></p><p>奇怪这个文件竟然不叫blueline 别人的都是和代号一样的</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> private/msm-google</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#生成deconfig</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ARCH=arm64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> b1c1_defconfig</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#打开配置UI</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ARCH=arm64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> menuconfig</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#按键 / 可以搜索</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#保存配置文件 会在private/msm-google目录下面生成一个deconfig 复制到下面的厂商目录中去</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ARCH=arm64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> savedefconfig</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#覆盖配置</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/pixel_kernel/private/msm-google/arch/arm64/configs/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#编译错了话，进入msm-google 目录 make mrproper清理下,因为有配置文件残留</span></span></code></pre></div><p>建议开启以下选项</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">来源</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">https://evilpan.com/2022/01/03/kernel-tracing/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">为了能够支持</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> KPROBES、UPROBES、TRACEPOINTS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 等功能，需要在内核的配置中添加以下选项:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">禁用内核的安全特性，开启调试支持:</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_KPROBES</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_BLK_DEV_IO_TRACE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_PROBE_EVENTS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_KPROBE_EVENT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-d </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_LTO</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-d </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_LTO_CLANG</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-d </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_CFI_CLANG</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-d </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CFI_PERMISSIVE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-d </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CFI_CLANG</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_IRQSOFF_TRACER</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_PREEMPT_TRACER</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_DEBUG_FS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_CHECKPOINT_RESTORE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-d </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_RANDOMIZE_BASE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">开启 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">eBPF</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 支持:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_BPF</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_BPF_SYSCALL</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_BPF_JIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_HAVE_EBPF_JIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_IKHEADERS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">开启 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kretprobe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 支持:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_KRETPROBES</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_HAVE_KRETPROBES</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-d </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_SHADOW_CALL_STACK</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_ROP_PROTECTION_NONE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">开启 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ftrace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 支持:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_FTRACE_SYSCALLS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_FUNCTION_TRACER</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_HAVE_DYNAMIC_FTRACE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_DYNAMIC_FTRACE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">开启 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">uprobes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 支持:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_UPROBES</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_UPROBE_EVENT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_BPF_EVENTS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BCC </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">建议设置的选项:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_DEBUG_PREEMPT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_PREEMPTIRQ_EVENTS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-d </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_PROVE_LOCKING</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-d </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">CONFIG_LOCKDEP</span></span></code></pre></div><p>选项太多了，懒得一个一个改</p><p>查看<code>./build_bluecross.sh</code>中对应的<code>BUILD_CONFIG=private/msm-google/build.config.bluecross_no-cfi</code> 直接修改<code>build.config.bluecross_no-cfi</code> 最好备份下</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DEFCONFIG</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b1c1_defconfig</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KERNEL_DIR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">private/msm-google</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${ROOT_DIR}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\${KERNEL_DIR}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/build.config.common.clang</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">POST_DEFCONFIG_CMDS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;check_defconfig &amp;&amp; update_nocfi_config&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> update_nocfi_config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Disable clang-specific options</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  \${KERNEL_DIR}</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/scripts/config</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${OUT_DIR}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/.config</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> LTO</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> LTO_CLANG</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CFI</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CFI_PERMISSIVE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CFI_CLANG</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_LTO</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_LTO_CLANG</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_CFI_CLANG</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CFI_PERMISSIVE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CFI_CLANG</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_IRQSOFF_TRACER</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_PREEMPT_TRACER</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_DEBUG_FS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_CHECKPOINT_RESTORE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_RANDOMIZE_BASE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_BPF</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_BPF_SYSCALL</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_BPF_JIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_HAVE_EBPF_JIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_IKHEADERS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_KRETPROBES</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_HAVE_KRETPROBES</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_SHADOW_CALL_STACK</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_ROP_PROTECTION_NONE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_FTRACE_SYSCALLS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_FUNCTION_TRACER</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_HAVE_DYNAMIC_FTRACE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_DYNAMIC_FTRACE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_UPROBES</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_UPROBE_EVENT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_BPF_EVENTS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_DEBUG_PREEMPT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_PREEMPTIRQ_EVENTS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_PROVE_LOCKING</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_LOCKDEP</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${OUT_DIR} &amp;&amp; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   make</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${CC_LD_ARG} </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">O=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\${OUT_DIR} </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">olddefconfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>再次编译下看看选项开启了没</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">adb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> shell</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zcat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /proc/config.gz</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CONFIG_PERF_EVENTS</span></span></code></pre></div><h3 id="凉凉" tabindex="-1">凉凉 <a class="header-anchor" href="#凉凉" aria-label="Permalink to &quot;凉凉&quot;">​</a></h3><p><a href="https://github.com/tiann/KernelSU/discussions/956" target="_blank" rel="noreferrer">https://github.com/tiann/KernelSU/discussions/956</a></p><p>开启 <code>CONFIG_KPROBE_EVENT</code> 选项开机就死机 4.9内核好像不支持 看了相关文章4.9是早于UPROBES之前的版本，需要反向添加已支持手机</p><p>这里暂告一段落，只能作为别的机型配置参考</p><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to &quot;参考&quot;">​</a></h2><p><a href="https://bbs.kanxue.com/thread-274790.htm" target="_blank" rel="noreferrer">https://bbs.kanxue.com/thread-274790.htm</a><a href="https://blog.seeflower.dev/archives/17/" target="_blank" rel="noreferrer">https://blog.seeflower.dev/archives/17/</a><a href="https://blog.arstercz.com/introduction_to_linux_dynamic_tracing/" target="_blank" rel="noreferrer">https://blog.arstercz.com/introduction_to_linux_dynamic_tracing/</a><a href="https://evilpan.com/2022/01/03/kernel-tracing/" target="_blank" rel="noreferrer">https://evilpan.com/2022/01/03/kernel-tracing/</a></p>`,67),p=[l];function k(t,e,F,d,r,g){return i(),a("div",null,p)}const o=s(h,[["render",k]]);export{C as __pageData,o as default};
